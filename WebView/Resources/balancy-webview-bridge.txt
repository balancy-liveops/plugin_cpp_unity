window.BalancyWebView = window.BalancyWebView || {};
const balancy = {};
        
// Set up request-response functionality
(function() {
    // Store for pending requests
    const pendingRequests = {};
    
    // Counter for generating sequential IDs
    let requestCounter = 0;

    const RequestAction = {
        None: 0,
        GetProfile: 1,
    };
    
    balancy.closeView = () => {
        window.BalancyWebView.postMessage("balancy_close_view");
    };

    balancy.getSystemProfileValue = (path) => {
        return window.BalancyWebView.sendRequest(RequestAction.GetProfile, {profile: "UnnyProfile", path});
    };

    balancy.getProfileValue = (profile, path) => {
        return window.BalancyWebView.sendRequest(RequestAction.GetProfile, {profile, path});
    };

    window.BalancyWebView.postMessage = function(message) {
        if (typeof message !== 'string') message = JSON.stringify(message);
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.BalancyWebView) {
            window.webkit.messageHandlers.BalancyWebView.postMessage(message);
            return true;
        }
        return false;
    };

    window.BalancyWebView._receiveMessageFromUnity = function(message) {
        try {
            const response = JSON.parse(message);
            if (response.type === 'response') {
                const request = pendingRequests[response.id];
                if (request) {
                    delete pendingRequests[response.id];
                    if (response.error) {
                        request.reject(new Error(response.error));
                    } else {
                        request.resolve(response.result);
                    }
                }
            }
        }  catch (error) {
            // console.error('Error handling response:', error);
        }
    };
    
    window.BalancyWebView.sendRequest = function(action, params = {}) {
        return new Promise((resolve, reject) => {
            const requestId = (requestCounter++).toString();
            
            pendingRequests[requestId] = {
                resolve: resolve,
                reject: reject,
                timestamp: Date.now()
            };
            
            const message = {
                type: 'request',
                id: requestId,
                action: action,
                params: params
            };
            
            window.BalancyWebView.postMessage(JSON.stringify(message));

            // setTimeout(() => {
            //     const request = pendingRequests[requestId];
            //     if (request) {
            //         delete pendingRequests[requestId];
            //         reject(new Error(`Request timeout: ${action}`));
            //     }
            // }, 10000); // 10 second timeout
        });
    };
    
    // Set up the message listener (runs only once during initialization)
    window.BalancyWebView.initResponseHandler = function() {
        if (window.BalancyWebView._responseHandlerInitialized) return;
        
        // Mark as initialized
        window.BalancyWebView._responseHandlerInitialized = true;
        
        // Create a handler for incoming messages from Unity
        window.BalancyWebView.handleResponse = function(responseJson) {
            try {
                const response = JSON.parse(responseJson);
                
                // Look for a matching request
                const request = pendingRequests[response.id];
                if (request) {
                    // Remove from pending
                    delete pendingRequests[response.id];
                    
                    // Call the appropriate callback
                    if (response.error) {
                        request.reject(new Error(response.error));
                    } else {
                        request.resolve(response.result);
                    }
                }
            } catch (error) {
                console.error('Error handling response:', error);
            }
        };
    };
    
    // Initialize the response handler
    window.BalancyWebView.initResponseHandler();
})();